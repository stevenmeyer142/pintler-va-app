## Upload to AWS HealthLake from VA App using AWS Amplify

This repository contains a client/server app that uploads VA patient records to AWS HealthLake.
This is an AWS Amplify project.

## Overview

The app uses a React frontend and multiple backend lambdas written in TypeScript.

The frontend code is in the folder "frontend".

The backend code is in the folders "amplify/functions" and "amplify/custom/va-access"

A DynamoDB database is used to track the resources and status.

## VA access setup.

The app is currently configured to use the VA patient sandbox database.

For personal development using Amplify sandbox, VA sandbox access must be requested and the correct redirect URL must be supplied.

[VA Patient Health Sandbox Access](https://developer.va.gov/explore/api/patient-health/sandbox-access)

The redirect url is prefixed with the Gateway URL for the VA Access serverless lambda. This can be found in the file "amplify_outputs.json" with the key "custom.gatewayURL". The file "amplify_outputs.json" is generated by the Amplify sandbox.

The redirect url takes the form `${gatewayURL}auth/cb`

The client_id and client_secret for VA Access are stored in the AWS Secrets Manager. These must be entered after requesting accessing.

The App ID of the API Gateway host prefix is used to designate a unique secret name as shown in the following example. This Gateway is used by the AWS Lambda function defined in "amplify/custom/va-access". It is the Gateway for the JS Express server.

Gateway url - https://czy03iz038.execute-api.us-east-1.amazonaws.com/

Secret name "dev/czy03iz038/va_client"
The secret must contain the keys- client_id and client_secret.

The code that uses the secrets can be found in the file "amplify/custom/va-access/src/app_backend.ts"

## Development Notes

Changes to amplify/custom/va-access require running the script "amplify/custom/va-access/build.sh"

## Issues

There is a problem with timeout for the Lambda functions. Sometimes a timeout error is received in React and the Lambda function is still running. Sometimes creating a HealthLake data store or importing to the data store cannot complete in the 15 minute limit for Lambda functions.

An alternative implementation could monitor the status of "CreateFHIRDatastore" and "StartFHIRImportJob" using EventBridge and SNS notifications to update the DynamoDB record, instead of using the actions "DescribeFHIRDatastore" and "DescribeFHIRImportJob".

## Deploying to AWS

For detailed instructions on deploying your application, refer to the [deployment section](https://docs.amplify.aws/react/start/quickstart/#deploy-a-fullstack-app-to-aws) in the AWS Amplify documentation.


